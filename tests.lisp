(in-package clvm)

(defun lit-tests ()
  (let ((*vm* (make-instance 'vm)))
    (emit (lit-form (int-type (abc-lib *vm*)) 42))
    (vm-eval)
    (assert (= (data (vm-pop)) 42))))

(defun label-tests ()
  (let* ((*vm* (make-instance 'vm))
	 (int (int-type (abc-lib *vm*))))
    (emit (goto-op :foo))
    (emit (push-op int 1))
    (emit (label-op :foo))
    (emit (push-op int 2))
    (vm-eval)
    (assert (= (data (vm-pop)) 2))
    (assert (null (vm-pop)))))

(defun branch-tests ()
  (let* ((*vm* (make-instance 'vm))
	 (bool (bool-type (abc-lib *vm*)))
	 (int (int-type (abc-lib *vm*))))
    (emit (push-op bool nil))
    (emit (branch-op :false))
    (emit (push-op int 1))
    (emit (goto-op :end))
    (emit (label-op :false))
    (emit (push-op int 2))
    (emit (label-op :end))
    (vm-eval)
    (assert (= (data (vm-pop)) 2))
    (assert (null (vm-pop)))))

(defun all-tests ()
  (lit-tests)
  (label-tests)
  (branch-tests))
  
